---
title: '聊天服务器使用'
date: '2012-09-03'
description:
categories: mmo
tags: [chat server]
analytics: false
comments: false
---

## 设计概要

聊天服务器（以下简称CS）在设计上将所有可接收聊天信息的对象抽象为实体（entity），包括：单个玩家、服务器、队伍、组队房间、工会等。每一个实体都有一个唯一的ID。任何实体都可以向其他实体发送聊天内容。针对不同类型的实体，其接收信息的方式不一样。例如对于队伍实体而言，其接收聊天信息时，实现上则是将此消息广播给队伍内所有成员。队伍内的所有成员实际上是单个玩家实体。

实体有3个行为：创建、修改、删除。不同类型的实体在这三个操作上都会不同。应用层需要根据不同类型的实体，围绕这3个操作编写逻辑代码，以使该实体在CS上能正常工作。

进一步地，CS将这些不同的实体在实现上分为几种固定的实体：

* 客户端实体

    表示一个独立的客户端，也就是一个玩家

* GS(Game Server)实体

    表示一个游戏服务器，该实体负责客户端实体的创建工作，维护一些跟游戏逻辑关联较大的实体，例如队伍、工会实体等。

* 组(Group)实体

    该实体维护一个实体集合，在发送消息方面，它将转发该消息给所有实体。组实体可以嵌套，意即其成员也可以为组实体。组实体囊括了诸如队伍、组队房间、同场景玩家、工会等各种实体。针对这些不同实体在GS上的逻辑，应用层也需要维护组实体的创建、修改、删除等行为。就目前的CS实现而言，应用层将主要围绕这一块开展工作。

## 实体协议

针对实体的3个行为，每一个行为都有固定的消息协议，用于在CS上操作实体。

### 创建(create)

实体的创建方式多种多样，例如GS实体由配置完成，客户端实体由GS实体完成等。实体的创建消息如下：
 
* type，实体的类型(例如CLIENT/GAME_SERVER/GROUP)，参考`EntityType`
* id，实体的ID，对客户端实体而言，ID使用玩家的ID
* brief，实体的简要名字，仅用于聊天信息的一些显示，可为玩家名字、工会名字等
* arguments，附加参数

针对`arguments`，不同实体的创建都不同：

* GS实体，无参数
* 客户端实体：

    * GS实体ID，标示该客户端实体位于哪一个GS实体上

* 组实体：

    * entity count，成员数量
    * entity list，成员列表，也就是实体ID列表

### 删除(destroy)

实体的删除操作一般由其创建者完成，消息较为简单：

* entity ID，携带实体ID即可

值得注意的是，一般而言，网络连接断开并不会导致CS自己将对应的实体删除，而是采用暂时将对应的实体标记为一种非连接的状态。

### 修改(modify)

修改实体主要是修改特定实体的内部状态，例如对于组实体而言该操作用于增删组成员，对于客户端和GS实体而言，该操作可修改实体的网络连接状态。格式为：

* entity ID，要修改实体的ID
* arguments，附加参数

附加参数针对不同类型的实体也不同：

* 客户端/GS实体：
    
    * state，实体状态，如CONNECTED/DISCONNECTED，参考`EntityStatus`

* 组实体

    * op，操作类型，`GroupOp::ADD`表示增加成员，`GroupOp::REMOVE`表示删除成员
    * entity ID，要操作的成员实体ID

### 发送聊天信息

聊天信息直接发送给某个实体，针对不同的实体类型，其处理消息的方式也不同，聊天消息格式为：

* receiver entity ID，接收者实体ID
* content，聊天内容字符串

### 接收聊天信息

实体在接收到聊天信息后，可以根据此格式解码出详细的聊天信息，格式为：

* sender entity ID，发送者实体ID
* sender brief，发送者brief，即发送者简要名字
* receiver entity ID，接收者实体ID
* content，聊天内容字符串

其中，如果客户端实体收到该消息，`receiver entity ID`不一定就是客户端实体，它可能是某个临时建立的聊天房间，当该聊天信息是玩家私聊时，`receiver entity ID`才是该客户端实体ID。

## 其他

本节描述部分已实现功能，其可作为使用例子。

### GS实体使用

GS实体由CS上配置决定，配置文件为`server_entities.ini`。该文件格式为：

        brief       GUID
    *   gs1         {xxx-xxx-xxx}
    *   gs2         {xxx-xxx-xxx}

CS在启动时将根据该配置创建出GS实体。每一个GS都需要配置自己，设置自己作为一个实体的信息，配置文件为`cs_setup.ini`，格式为：

    ENABLE      1
    IP          xx.xxx.xx.xx
    PORT        xxx
    GUID        {xxx-xxx-xxx}

其中，`GUID`项需要对应CS中的配置。GS连接上CS后，对应的GS实体才算正常。

### 客户端实体

当角色进入某个GS时，该GS实体就在CS上建立该客户端实体，然后发送CS信息给该客户端。当该客户端连接到CS上时，客户端主动修改自身实体的连接状态。当角色退出该GS时，GS就在CS上请求删除该客户端实体。

### 场景组实体

当某个场景（含副本）被创建时，GS就在CS上创建该组实体。当某个角色进入离开该场景时，GS对该场景实体进行增删成员的操作。

